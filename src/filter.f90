module mod_polyphase
    use kind_m
    implicit none
    private
    public polyphase_filter36
    integer, parameter :: nsize = 512, nband = 32
    real (kind = kd), save :: coeff(0:nband - 1, 0:nband - 1), prototype(nsize)
    real (kind = kd), save :: pi
contains
!----------------------------------------------------------------------
    subroutine load_window(w)
        real (kind = kd), intent(out) :: w(:) ! iso table c.1 coefficients ci of the analysis window
        w(  1:  4) = (/  0.000000000_kd, -0.000000477_kd, -0.000000477_kd, -0.000000477_kd /) 
        w(  5:  8) = (/ -0.000000477_kd, -0.000000477_kd, -0.000000477_kd, -0.000000954_kd /) 
        w(  9: 12) = (/ -0.000000954_kd, -0.000000954_kd, -0.000000954_kd, -0.000001431_kd /) 
        w( 13: 16) = (/ -0.000001431_kd, -0.000001907_kd, -0.000001907_kd, -0.000002384_kd /) 
        w( 17: 20) = (/ -0.000002384_kd, -0.000002861_kd, -0.000003338_kd, -0.000003338_kd /) 
        w( 21: 24) = (/ -0.000003815_kd, -0.000004292_kd, -0.000004768_kd, -0.000005245_kd /) 
        w( 25: 28) = (/ -0.000006199_kd, -0.000006676_kd, -0.000007629_kd, -0.000008106_kd /) 
        w( 29: 32) = (/ -0.000009060_kd, -0.000010014_kd, -0.000011444_kd, -0.000012398_kd /) 
        w( 33: 36) = (/ -0.000013828_kd, -0.000014782_kd, -0.000016689_kd, -0.000018120_kd /) 
        w( 37: 40) = (/ -0.000019550_kd, -0.000021458_kd, -0.000023365_kd, -0.000025272_kd /) 
        w( 41: 44) = (/ -0.000027657_kd, -0.000030041_kd, -0.000032425_kd, -0.000034809_kd /) 
        w( 45: 48) = (/ -0.000037670_kd, -0.000040531_kd, -0.000043392_kd, -0.000046253_kd /) 
        w( 49: 52) = (/ -0.000049591_kd, -0.000052929_kd, -0.000055790_kd, -0.000059605_kd /) 
        w( 53: 56) = (/ -0.000062943_kd, -0.000066280_kd, -0.000070095_kd, -0.000073433_kd /) 
        w( 57: 60) = (/ -0.000076771_kd, -0.000080585_kd, -0.000083923_kd, -0.000087261_kd /) 
        w( 61: 64) = (/ -0.000090599_kd, -0.000093460_kd, -0.000096321_kd, -0.000099182_kd /) 
        w( 65: 68) = (/  0.000101566_kd,  0.000103951_kd,  0.000105858_kd,  0.000107288_kd /) 
        w( 69: 72) = (/  0.000108242_kd,  0.000108719_kd,  0.000108719_kd,  0.000108242_kd /) 
        w( 73: 76) = (/  0.000106812_kd,  0.000105381_kd,  0.000102520_kd,  0.000099182_kd /) 
        w( 77: 80) = (/  0.000095367_kd,  0.000090122_kd,  0.000084400_kd,  0.000077724_kd /) 
        w( 81: 84) = (/  0.000069618_kd,  0.000060558_kd,  0.000050545_kd,  0.000039577_kd /) 
        w( 85: 88) = (/  0.000027180_kd,  0.000013828_kd, -0.000000954_kd, -0.000017166_kd /) 
        w( 89: 92) = (/ -0.000034332_kd, -0.000052929_kd, -0.000072956_kd, -0.000093937_kd /) 
        w( 93: 96) = (/ -0.000116348_kd, -0.000140190_kd, -0.000165462_kd, -0.000191212_kd /) 
        w( 97:100) = (/ -0.000218868_kd, -0.000247478_kd, -0.000277042_kd, -0.000307560_kd /) 
        w(101:104) = (/ -0.000339031_kd, -0.000371456_kd, -0.000404358_kd, -0.000438213_kd /) 
        w(105:108) = (/ -0.000472546_kd, -0.000507355_kd, -0.000542164_kd, -0.000576973_kd /) 
        w(109:112) = (/ -0.000611782_kd, -0.000646591_kd, -0.000680923_kd, -0.000714302_kd /) 
        w(113:116) = (/ -0.000747204_kd, -0.000779152_kd, -0.000809669_kd, -0.000838757_kd /) 
        w(117:120) = (/ -0.000866413_kd, -0.000891685_kd, -0.000915051_kd, -0.000935555_kd /) 
        w(121:124) = (/ -0.000954151_kd, -0.000968933_kd, -0.000980854_kd, -0.000989437_kd /) 
        w(125:128) = (/ -0.000994205_kd, -0.000995159_kd, -0.000991821_kd, -0.000983715_kd /) 
        w(129:132) = (/  0.000971317_kd,  0.000953674_kd,  0.000930786_kd,  0.000902653_kd /) 
        w(133:136) = (/  0.000868797_kd,  0.000829220_kd,  0.000783920_kd,  0.000731945_kd /) 
        w(137:140) = (/  0.000674248_kd,  0.000610352_kd,  0.000539303_kd,  0.000462532_kd /) 
        w(141:144) = (/  0.000378609_kd,  0.000288486_kd,  0.000191689_kd,  0.000088215_kd /) 
        w(145:148) = (/ -0.000021458_kd, -0.000137329_kd, -0.000259876_kd, -0.000388145_kd /) 
        w(149:152) = (/ -0.000522137_kd, -0.000661850_kd, -0.000806808_kd, -0.000956535_kd /) 
        w(153:156) = (/ -0.001111031_kd, -0.001269817_kd, -0.001432419_kd, -0.001597881_kd /) 
        w(157:160) = (/ -0.001766682_kd, -0.001937389_kd, -0.002110004_kd, -0.002283096_kd /) 
        w(161:164) = (/ -0.002457142_kd, -0.002630711_kd, -0.002803326_kd, -0.002974033_kd /) 
        w(165:168) = (/ -0.003141880_kd, -0.003306866_kd, -0.003467083_kd, -0.003622532_kd /) 
        w(169:172) = (/ -0.003771782_kd, -0.003914356_kd, -0.004048824_kd, -0.004174709_kd /) 
        w(173:176) = (/ -0.004290581_kd, -0.004395962_kd, -0.004489899_kd, -0.004570484_kd /) 
        w(177:180) = (/ -0.004638195_kd, -0.004691124_kd, -0.004728317_kd, -0.004748821_kd /) 
        w(181:184) = (/ -0.004752159_kd, -0.004737377_kd, -0.004703045_kd, -0.004649162_kd /) 
        w(185:188) = (/ -0.004573822_kd, -0.004477024_kd, -0.004357815_kd, -0.004215240_kd /) 
        w(189:192) = (/ -0.004049301_kd, -0.003858566_kd, -0.003643036_kd, -0.003401756_kd /) 
        w(193:196) = (/  0.003134727_kd,  0.002841473_kd,  0.002521515_kd,  0.002174854_kd /) 
        w(197:200) = (/  0.001800537_kd,  0.001399517_kd,  0.000971317_kd,  0.000515938_kd /) 
        w(201:204) = (/  0.000033379_kd, -0.000475883_kd, -0.001011848_kd, -0.001573563_kd /) 
        w(205:208) = (/ -0.002161503_kd, -0.002774239_kd, -0.003411293_kd, -0.004072189_kd /) 
        w(209:212) = (/ -0.004756451_kd, -0.005462170_kd, -0.006189346_kd, -0.006937027_kd /) 
        w(213:216) = (/ -0.007703304_kd, -0.008487225_kd, -0.009287834_kd, -0.010103703_kd /) 
        w(217:220) = (/ -0.010933399_kd, -0.011775017_kd, -0.012627602_kd, -0.013489246_kd /) 
        w(221:224) = (/ -0.014358521_kd, -0.015233517_kd, -0.016112804_kd, -0.016994476_kd /) 
        w(225:228) = (/ -0.017876148_kd, -0.018756866_kd, -0.019634247_kd, -0.020506859_kd /) 
        w(229:232) = (/ -0.021372318_kd, -0.022228718_kd, -0.023074150_kd, -0.023907185_kd /) 
        w(233:236) = (/ -0.024725437_kd, -0.025527000_kd, -0.026310921_kd, -0.027073860_kd /) 
        w(237:240) = (/ -0.027815342_kd, -0.028532982_kd, -0.029224873_kd, -0.029890060_kd /) 
        w(241:244) = (/ -0.030526638_kd, -0.031132698_kd, -0.031706810_kd, -0.032248020_kd /) 
        w(245:248) = (/ -0.032754898_kd, -0.033225536_kd, -0.033659935_kd, -0.034055710_kd /) 
        w(249:252) = (/ -0.034412861_kd, -0.034730434_kd, -0.035007000_kd, -0.035242081_kd /) 
        w(253:256) = (/ -0.035435200_kd, -0.035586357_kd, -0.035694122_kd, -0.035758972_kd /) 
        w(257:260) = (/  0.035780907_kd,  0.035758972_kd,  0.035694122_kd,  0.035586357_kd /) 
        w(261:264) = (/  0.035435200_kd,  0.035242081_kd,  0.035007000_kd,  0.034730434_kd /) 
        w(265:268) = (/  0.034412861_kd,  0.034055710_kd,  0.033659935_kd,  0.033225536_kd /) 
        w(269:272) = (/  0.032754898_kd,  0.032248020_kd,  0.031706810_kd,  0.031132698_kd /) 
        w(273:276) = (/  0.030526638_kd,  0.029890060_kd,  0.029224873_kd,  0.028532982_kd /) 
        w(277:280) = (/  0.027815342_kd,  0.027073860_kd,  0.026310921_kd,  0.025527000_kd /) 
        w(281:284) = (/  0.024725437_kd,  0.023907185_kd,  0.023074150_kd,  0.022228718_kd /) 
        w(285:288) = (/  0.021372318_kd,  0.020506859_kd,  0.019634247_kd,  0.018756866_kd /) 
        w(289:292) = (/  0.017876148_kd,  0.016994476_kd,  0.016112804_kd,  0.015233517_kd /) 
        w(293:296) = (/  0.014358521_kd,  0.013489246_kd,  0.012627602_kd,  0.011775017_kd /) 
        w(297:300) = (/  0.010933399_kd,  0.010103703_kd,  0.009287834_kd,  0.008487225_kd /) 
        w(301:304) = (/  0.007703304_kd,  0.006937027_kd,  0.006189346_kd,  0.005462170_kd /) 
        w(305:308) = (/  0.004756451_kd,  0.004072189_kd,  0.003411293_kd,  0.002774239_kd /) 
        w(309:312) = (/  0.002161503_kd,  0.001573563_kd,  0.001011848_kd,  0.000475883_kd /) 
        w(313:316) = (/ -0.000033379_kd, -0.000515938_kd, -0.000971317_kd, -0.001399517_kd /) 
        w(317:320) = (/ -0.001800537_kd, -0.002174854_kd, -0.002521515_kd, -0.002841473_kd /) 
        w(321:324) = (/  0.003134727_kd,  0.003401756_kd,  0.003643036_kd,  0.003858566_kd /) 
        w(325:328) = (/  0.004049301_kd,  0.004215240_kd,  0.004357815_kd,  0.004477024_kd /) 
        w(329:332) = (/  0.004573822_kd,  0.004649162_kd,  0.004703045_kd,  0.004737377_kd /) 
        w(333:336) = (/  0.004752159_kd,  0.004748821_kd,  0.004728317_kd,  0.004691124_kd /) 
        w(337:340) = (/  0.004638195_kd,  0.004570484_kd,  0.004489899_kd,  0.004395962_kd /) 
        w(341:344) = (/  0.004290581_kd,  0.004174709_kd,  0.004048824_kd,  0.003914356_kd /) 
        w(345:348) = (/  0.003771782_kd,  0.003622532_kd,  0.003467083_kd,  0.003306866_kd /) 
        w(349:352) = (/  0.003141880_kd,  0.002974033_kd,  0.002803326_kd,  0.002630711_kd /) 
        w(353:356) = (/  0.002457142_kd,  0.002283096_kd,  0.002110004_kd,  0.001937389_kd /) 
        w(357:360) = (/  0.001766682_kd,  0.001597881_kd,  0.001432419_kd,  0.001269817_kd /) 
        w(361:364) = (/  0.001111031_kd,  0.000956535_kd,  0.000806808_kd,  0.000661850_kd /) 
        w(365:368) = (/  0.000522137_kd,  0.000388145_kd,  0.000259876_kd,  0.000137329_kd /) 
        w(369:372) = (/  0.000021458_kd, -0.000088215_kd, -0.000191689_kd, -0.000288486_kd /) 
        w(373:376) = (/ -0.000378609_kd, -0.000462532_kd, -0.000539303_kd, -0.000610352_kd /) 
        w(377:380) = (/ -0.000674248_kd, -0.000731945_kd, -0.000783920_kd, -0.000829220_kd /) 
        w(381:384) = (/ -0.000868797_kd, -0.000902653_kd, -0.000930786_kd, -0.000953674_kd /) 
        w(385:388) = (/  0.000971317_kd,  0.000983715_kd,  0.000991821_kd,  0.000995159_kd /) 
        w(389:392) = (/  0.000994205_kd,  0.000989437_kd,  0.000980854_kd,  0.000968933_kd /) 
        w(393:396) = (/  0.000954151_kd,  0.000935555_kd,  0.000915051_kd,  0.000891685_kd /) 
        w(397:400) = (/  0.000866413_kd,  0.000838757_kd,  0.000809669_kd,  0.000779152_kd /) 
        w(401:404) = (/  0.000747204_kd,  0.000714302_kd,  0.000680923_kd,  0.000646591_kd /) 
        w(405:408) = (/  0.000611782_kd,  0.000576973_kd,  0.000542164_kd,  0.000507355_kd /) 
        w(409:412) = (/  0.000472546_kd,  0.000438213_kd,  0.000404358_kd,  0.000371456_kd /) 
        w(413:416) = (/  0.000339031_kd,  0.000307560_kd,  0.000277042_kd,  0.000247478_kd /) 
        w(417:420) = (/  0.000218868_kd,  0.000191212_kd,  0.000165462_kd,  0.000140190_kd /) 
        w(421:424) = (/  0.000116348_kd,  0.000093937_kd,  0.000072956_kd,  0.000052929_kd /) 
        w(425:428) = (/  0.000034332_kd,  0.000017166_kd,  0.000000954_kd, -0.000013828_kd /) 
        w(429:432) = (/ -0.000027180_kd, -0.000039577_kd, -0.000050545_kd, -0.000060558_kd /) 
        w(433:436) = (/ -0.000069618_kd, -0.000077724_kd, -0.000084400_kd, -0.000090122_kd /) 
        w(437:440) = (/ -0.000095367_kd, -0.000099182_kd, -0.000102520_kd, -0.000105381_kd /) 
        w(441:444) = (/ -0.000106812_kd, -0.000108242_kd, -0.000108719_kd, -0.000108719_kd /) 
        w(445:448) = (/ -0.000108242_kd, -0.000107288_kd, -0.000105858_kd, -0.000103951_kd /) 
        w(449:452) = (/  0.000101566_kd,  0.000099182_kd,  0.000096321_kd,  0.000093460_kd /) 
        w(453:456) = (/  0.000090599_kd,  0.000087261_kd,  0.000083923_kd,  0.000080585_kd /) 
        w(457:460) = (/  0.000076771_kd,  0.000073433_kd,  0.000070095_kd,  0.000066280_kd /) 
        w(461:464) = (/  0.000062943_kd,  0.000059605_kd,  0.000055790_kd,  0.000052929_kd /) 
        w(465:468) = (/  0.000049591_kd,  0.000046253_kd,  0.000043392_kd,  0.000040531_kd /) 
        w(469:472) = (/  0.000037670_kd,  0.000034809_kd,  0.000032425_kd,  0.000030041_kd /) 
        w(473:476) = (/  0.000027657_kd,  0.000025272_kd,  0.000023365_kd,  0.000021458_kd /) 
        w(477:480) = (/  0.000019550_kd,  0.000018120_kd,  0.000016689_kd,  0.000014782_kd /) 
        w(481:484) = (/  0.000013828_kd,  0.000012398_kd,  0.000011444_kd,  0.000010014_kd /) 
        w(485:488) = (/  0.000009060_kd,  0.000008106_kd,  0.000007629_kd,  0.000006676_kd /) 
        w(489:492) = (/  0.000006199_kd,  0.000005245_kd,  0.000004768_kd,  0.000004292_kd /) 
        w(493:496) = (/  0.000003815_kd,  0.000003338_kd,  0.000003338_kd,  0.000002861_kd /) 
        w(497:500) = (/  0.000002384_kd,  0.000002384_kd,  0.000001907_kd,  0.000001907_kd /) 
        w(501:504) = (/  0.000001431_kd,  0.000001431_kd,  0.000000954_kd,  0.000000954_kd /) 
        w(505:508) = (/  0.000000954_kd,  0.000000954_kd,  0.000000477_kd,  0.000000477_kd /) 
        w(509:512) = (/  0.000000477_kd,  0.000000477_kd,  0.000000477_kd,  0.000000477_kd /)
    end subroutine load_window
    !----------------------------------------------------------------------
    subroutine initialize_polyphase()
        integer :: i, j
        pi = 4.0_kd * atan(1.0_kd)  
        call load_window(prototype)  
        ! c.1.3 analysis subbband filter
        forall (i = 0:31, j = 0:31) coeff(i, j) = cos(mod((2 * i + 1) * j, 128) * pi / 64.0_kd)  
    end subroutine initialize_polyphase
!----------------------------------------------------------------------
    subroutine polyphase_filter(z, s)
        real (kind = kd), intent(in ) :: z(:)
        real (kind = kd), intent(out) :: s(:)
        real (kind = kd) ::  y(64), f(0:31)
        integer :: i
        forall (i = 1:64) y(i) = sum(z(i:512:64)) 
        f( 0)    = y(17)
        f( 1:16) = y(18:33) + y(16: 1:-1)
        f(17:31) = y(34:48) - y(64:50:-1)
        s = matmul(coeff, f)
    end subroutine polyphase_filter
!----------------------------------------------------------------------
    subroutine polyphase_filter36(pcm, subband)
        real (kind = kd), intent(in ) :: pcm(:, :)
        real (kind = kd), intent(out) :: subband(:, :, :)
        real (kind = kd) :: tmp(512)
        integer        :: i, ichannel, istart, iend
        logical, save :: qfirst = .true.
        if (qfirst) then
            qfirst = .false.
            call initialize_polyphase()
        end if
        do i =  1, 36
            istart = 32 * (i - 1) + 512 
            iend   = 32 * (i - 1) +   1
            do ichannel = 1, size(pcm, 2)
                tmp = prototype * pcm(istart:iend:-1, ichannel)
                call polyphase_filter(tmp, subband(:, i, ichannel))
            end do
        end do
    end subroutine polyphase_filter36
!----------------------------------------------------------------------
end module mod_polyphase